{
    "sourceFile": "ZOOTOPIA/src/main/java/com/aloha/zootopia/controller/HospitalController.java",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1751814130923,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1751814159826,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,170 @@\n+package com.aloha.zootopia.controller;\n+\n+import java.security.Principal;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.Model;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.ModelAttribute;\n+import org.springframework.web.bind.annotation.PathVariable;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.multipart.MultipartFile;\n+\n+import com.aloha.zootopia.domain.Hospital;\n+import com.aloha.zootopia.dto.HospReviewForm;\n+import com.aloha.zootopia.dto.HospitalForm;\n+import com.aloha.zootopia.dto.PageInfo;\n+import com.aloha.zootopia.mapper.UserMapper;\n+import com.aloha.zootopia.service.AnimalService;\n+import com.aloha.zootopia.service.HospitalService;\n+// import com.github.pagehelper.PageInfo;\n+import com.aloha.zootopia.service.hospital.HospitalImageUploader;\n+\n+@Controller\n+public class HospitalController {\n+    @Autowired HospitalService hospitalService;\n+    @Autowired AnimalService animalService;\n+    @Autowired UserMapper userMapper;\n+    @Autowired HospitalImageUploader hospitalImageUploader;\n+\n+    public HospitalController(HospitalService hospitalService, AnimalService animalService, com.aloha.zootopia.mapper.UserMapper userMapper) {\n+        this.hospitalService = hospitalService;\n+        this.animalService = animalService;\n+    }\n+\n+    // @GetMapping(\"/hospitals\")\n+    // public String list(@RequestParam(required = false) List<Integer> animal, Model model) {\n+    //     model.addAttribute(\"animalList\", hospitalService.getAllAnimals());\n+    //     model.addAttribute(\"selectedAnimals\", animal == null ? new ArrayList<>() : animal);\n+    //     model.addAttribute(\"hospitals\", hospitalService.getHospitals(animal));\n+    //     return \"service/hospital/hosp_list\";\n+    // }\n+\n+    @GetMapping(\"/hospitals\")\n+    public String list(\n+        @RequestParam(required = false) List<Integer> animal,\n+        @RequestParam(value = \"pageNum\", defaultValue = \"1\") int pageNum,\n+        Model model) {\n+\n+        int pageSize = 6;\n+        int total = hospitalService.getHospitalCount(animal);\n+        List<Hospital> hospitalList = hospitalService.getHospitalList(animal, pageNum, pageSize);\n+\n+        PageInfo pageInfo = new PageInfo();\n+        pageInfo.setPageNum(pageNum);\n+        pageInfo.setPageSize(pageSize);\n+        pageInfo.setTotal(total);\n+        int pages = (int) Math.ceil((double) total / pageSize);\n+        pageInfo.setPages(pages);\n+\n+        // 네비게이션 계산 (5개씩)\n+        int navSize = 5;\n+        int startPage = ((pageNum - 1) / navSize) * navSize + 1;\n+        int endPage = Math.min(startPage + navSize - 1, pages);\n+        pageInfo.setStartPage(startPage);\n+        pageInfo.setEndPage(endPage);\n+        pageInfo.setHasPreviousPage(pageNum > 1);\n+        pageInfo.setHasNextPage(pageNum < pages);\n+        pageInfo.setHasFirstPage(pages > 1);\n+        pageInfo.setHasLastPage(endPage < pages);\n+\n+        model.addAttribute(\"hospitalList\", hospitalList);\n+        model.addAttribute(\"pageInfo\", pageInfo);\n+        model.addAttribute(\"animalList\", hospitalService.getAllAnimals());\n+        String selectedAnimalsString = \"\";\n+        if (animal != null && !animal.isEmpty()) {\n+            selectedAnimalsString = animal.stream()\n+                                        .map(String::valueOf)\n+                                        .collect(Collectors.joining(\",\"));\n+        }\n+        model.addAttribute(\"selectedAnimals\", animal == null ? new ArrayList<>() : animal); // 기존 리스트도 유지\n+        model.addAttribute(\"selectedAnimalsString\", selectedAnimalsString); // 새로 추가\n+\n+        return \"service/hospital/hosp_list\";\n+    }\n+\n+\n+    @GetMapping(\"/hospitals/detail/{id}\")\n+    public String details(@PathVariable Integer id, Model model) {\n+        model.addAttribute(\"hospital\", hospitalService.getHospital(id));\n+        model.addAttribute(\"reviews\", hospitalService.getReviews(id));\n+        model.addAttribute(\"reviewForm\", new HospReviewForm());\n+        return \"service/hospital/details\";\n+    }\n+\n+    // @PreAuthorize(\"hasRole('ADMIN')\")\n+    @GetMapping(\"/hospitals/new\")\n+    public String createForm(Model model) {\n+        model.addAttribute(\"hospitalForm\", new HospitalForm());\n+        model.addAttribute(\"specialtyList\", hospitalService.getAllSpecialties());\n+        model.addAttribute(\"animalList\", hospitalService.getAllAnimals());\n+        return \"service/hospital/create_hospital\";\n+    }\n+\n+    // @PreAuthorize(\"hasRole('ADMIN')\")\n+    @PostMapping(\"/hospitals\")\n+    public String create(@ModelAttribute HospitalForm form, @RequestParam(value = \"thumbnailImageFile\", required = false) MultipartFile thumbnailImageFile) throws Exception {\n+        if (thumbnailImageFile != null && !thumbnailImageFile.isEmpty()) {\n+            String imageUrl = hospitalImageUploader.uploadFile(thumbnailImageFile);\n+            form.setThumbnailImageUrl(imageUrl);\n+        }\n+        hospitalService.createHospital(form);\n+        return \"redirect:/hospitals\";\n+    }\n+\n+    @PostMapping(\"/hospitals/{id}/reviews\")\n+    public String addReview(@PathVariable Integer id, @ModelAttribute HospReviewForm form, Principal principal) {\n+        if (principal == null) {\n+            // 로그인하지 않은 사용자 처리 (예: 로그인 페이지로 리다이렉트)\n+            return \"redirect:/login\"; // 또는 다른 로그인 페이지 경로\n+        }\n+        String username = principal.getName(); // 이메일 (username)\n+        com.aloha.zootopia.domain.Users user = null;\n+        try {\n+            user = userMapper.select(username);\n+        } catch (Exception e) {\n+            // 사용자 조회 실패 처리\n+            e.printStackTrace();\n+            return \"redirect:/error\"; // 또는 적절한 오류 페이지로 리다이렉트\n+        }\n+        if (user == null) {\n+            return \"redirect:/login\"; // 사용자 정보가 없으면 로그인 페이지로\n+        }\n+        Integer userId = (int) user.getUserId(); // long을 int로 캐스팅\n+        String nickname = user.getNickname(); // Users 엔티티에 nickname 필드가 있다고 가정\n+\n+        hospitalService.addReview(id, form, nickname, userId);\n+        return \"redirect:/hospitals/detail/\" + id;\n+    }\n+\n+    @PostMapping(\"/hospitals/{id}/reviews/{reviewId}/edit\")\n+    public String updateReview(@PathVariable Integer id,\n+                               @PathVariable Integer reviewId,\n+                               @RequestParam String content,\n+                               Principal principal) {\n+        if (principal == null) {\n+            return \"redirect:/login\";\n+        }\n+        String username = principal.getName(); // 이메일 (username)\n+        com.aloha.zootopia.domain.Users user = null;\n+        try {\n+            user = userMapper.select(username);\n+        } catch (Exception e) {\n+            // 사용자 조회 실패 처리\n+            e.printStackTrace();\n+            return \"redirect:/error\"; // 또는 적절한 오류 페이지로 리다이렉트\n+        }\n+        if (user == null) {\n+            return \"redirect:/login\"; // 사용자 정보가 없으면 로그인 페이지로\n+        }\n+        Integer userId = (int) user.getUserId(); // long을 int로 캐스팅\n+\n+        hospitalService.updateReview(reviewId, content, userId);\n+        return \"redirect:/hospitals/detail/\" + id;\n+    }\n+}\n\\ No newline at end of file\n"
                }
            ],
            "date": 1751814130923,
            "name": "Commit-0",
            "content": "package com.aloha.zootopia.controller;\n\nimport java.security.Principal;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.stream.Collectors;\n\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Controller;\nimport org.springframework.ui.Model;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.ModelAttribute;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\n\nimport com.aloha.zootopia.domain.Hospital;\nimport com.aloha.zootopia.dto.HospReviewForm;\nimport com.aloha.zootopia.dto.HospitalForm;\nimport com.aloha.zootopia.dto.PageInfo;\nimport com.aloha.zootopia.mapper.UserMapper;\nimport com.aloha.zootopia.service.AnimalService;\nimport com.aloha.zootopia.service.HospitalService;\n// import com.github.pagehelper.PageInfo;\nimport com.aloha.zootopia.service.hospital.HospitalImageUploader;\n\n@Controller\npublic class HospitalController {\n    @Autowired HospitalService hospitalService;\n    @Autowired AnimalService animalService;\n    @Autowired UserMapper userMapper;\n    @Autowired HospitalImageUploader hospitalImageUploader;\n\n    public HospitalController(HospitalService hospitalService, AnimalService animalService, com.aloha.zootopia.mapper.UserMapper userMapper) {\n        this.hospitalService = hospitalService;\n        this.animalService = animalService;\n    }\n\n    // @GetMapping(\"/hospitals\")\n    // public String list(@RequestParam(required = false) List<Integer> animal, Model model) {\n    //     model.addAttribute(\"animalList\", hospitalService.getAllAnimals());\n    //     model.addAttribute(\"selectedAnimals\", animal == null ? new ArrayList<>() : animal);\n    //     model.addAttribute(\"hospitals\", hospitalService.getHospitals(animal));\n    //     return \"service/hospital/hosp_list\";\n    // }\n\n    @GetMapping(\"/hospitals\")\n    public String list(\n        @RequestParam(required = false) List<Integer> animal,\n        @RequestParam(value = \"pageNum\", defaultValue = \"1\") int pageNum,\n        Model model) {\n\n        int pageSize = 6;\n        int total = hospitalService.getHospitalCount(animal);\n        List<Hospital> hospitalList = hospitalService.getHospitalList(animal, pageNum, pageSize);\n\n        PageInfo pageInfo = new PageInfo();\n        pageInfo.setPageNum(pageNum);\n        pageInfo.setPageSize(pageSize);\n        pageInfo.setTotal(total);\n        int pages = (int) Math.ceil((double) total / pageSize);\n        pageInfo.setPages(pages);\n\n        // 네비게이션 계산 (5개씩)\n        int navSize = 5;\n        int startPage = ((pageNum - 1) / navSize) * navSize + 1;\n        int endPage = Math.min(startPage + navSize - 1, pages);\n        pageInfo.setStartPage(startPage);\n        pageInfo.setEndPage(endPage);\n        pageInfo.setHasPreviousPage(pageNum > 1);\n        pageInfo.setHasNextPage(pageNum < pages);\n        pageInfo.setHasFirstPage(pages > 1);\n        pageInfo.setHasLastPage(endPage < pages);\n\n        model.addAttribute(\"hospitalList\", hospitalList);\n        model.addAttribute(\"pageInfo\", pageInfo);\n        model.addAttribute(\"animalList\", hospitalService.getAllAnimals());\n        String selectedAnimalsString = \"\";\n        if (animal != null && !animal.isEmpty()) {\n            selectedAnimalsString = animal.stream()\n                                        .map(String::valueOf)\n                                        .collect(Collectors.joining(\",\"));\n        }\n        model.addAttribute(\"selectedAnimals\", animal == null ? new ArrayList<>() : animal); // 기존 리스트도 유지\n        model.addAttribute(\"selectedAnimalsString\", selectedAnimalsString); // 새로 추가\n\n        return \"service/hospital/hosp_list\";\n    }\n\n\n    @GetMapping(\"/hospitals/detail/{id}\")\n    public String details(@PathVariable Integer id, Model model) {\n        model.addAttribute(\"hospital\", hospitalService.getHospital(id));\n        model.addAttribute(\"reviews\", hospitalService.getReviews(id));\n        model.addAttribute(\"reviewForm\", new HospReviewForm());\n        return \"service/hospital/details\";\n    }\n\n    // @PreAuthorize(\"hasRole('ADMIN')\")\n    @GetMapping(\"/hospitals/new\")\n    public String createForm(Model model) {\n        model.addAttribute(\"hospitalForm\", new HospitalForm());\n        model.addAttribute(\"specialtyList\", hospitalService.getAllSpecialties());\n        model.addAttribute(\"animalList\", hospitalService.getAllAnimals());\n        return \"service/hospital/create_hospital\";\n    }\n\n    // @PreAuthorize(\"hasRole('ADMIN')\")\n    @PostMapping(\"/hospitals\")\n    public String create(@ModelAttribute HospitalForm form, @RequestParam(value = \"thumbnailImageFile\", required = false) MultipartFile thumbnailImageFile) throws Exception {\n        if (thumbnailImageFile != null && !thumbnailImageFile.isEmpty()) {\n            String imageUrl = hospitalImageUploader.uploadFile(thumbnailImageFile);\n            form.setThumbnailImageUrl(imageUrl);\n        }\n        hospitalService.createHospital(form);\n        return \"redirect:/hospitals\";\n    }\n\n    @PostMapping(\"/hospitals/{id}/reviews\")\n    public String addReview(@PathVariable Integer id, @ModelAttribute HospReviewForm form, Principal principal) {\n        if (principal == null) {\n            // 로그인하지 않은 사용자 처리 (예: 로그인 페이지로 리다이렉트)\n            return \"redirect:/login\"; // 또는 다른 로그인 페이지 경로\n        }\n        String username = principal.getName(); // 이메일 (username)\n        com.aloha.zootopia.domain.Users user = null;\n        try {\n            user = userMapper.select(username);\n        } catch (Exception e) {\n            // 사용자 조회 실패 처리\n            e.printStackTrace();\n            return \"redirect:/error\"; // 또는 적절한 오류 페이지로 리다이렉트\n        }\n        if (user == null) {\n            return \"redirect:/login\"; // 사용자 정보가 없으면 로그인 페이지로\n        }\n        Integer userId = (int) user.getUserId(); // long을 int로 캐스팅\n        String nickname = user.getNickname(); // Users 엔티티에 nickname 필드가 있다고 가정\n\n        hospitalService.addReview(id, form, nickname, userId);\n        return \"redirect:/hospitals/detail/\" + id;\n    }\n\n    @PostMapping(\"/hospitals/{id}/reviews/{reviewId}/edit\")\n    public String updateReview(@PathVariable Integer id,\n                               @PathVariable Integer reviewId,\n                               @RequestParam String content,\n                               Principal principal) {\n        if (principal == null) {\n            return \"redirect:/login\";\n        }\n        String username = principal.getName(); // 이메일 (username)\n        com.aloha.zootopia.domain.Users user = null;\n        try {\n            user = userMapper.select(username);\n        } catch (Exception e) {\n            // 사용자 조회 실패 처리\n            e.printStackTrace();\n            return \"redirect:/error\"; // 또는 적절한 오류 페이지로 리다이렉트\n        }\n        if (user == null) {\n            return \"redirect:/login\"; // 사용자 정보가 없으면 로그인 페이지로\n        }\n        Integer userId = (int) user.getUserId(); // long을 int로 캐스팅\n\n        hospitalService.updateReview(reviewId, content, userId);\n        return \"redirect:/hospitals/detail/\" + id;\n    }\n}"
        }
    ]
}