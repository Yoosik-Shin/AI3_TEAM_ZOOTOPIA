<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title th:text="${productName} + ' - ZOOTOPIA'">ìƒí’ˆ ìƒì„¸ - ZOOTOPIA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/dist/css/product-detail.css">
    <link rel="stylesheet" th:href="@{/assets/dist/css/header.css}">
    <style>
        .navbar-brand img {
            height: 40px;
        }
        .product-image {
            max-height: 500px;
            object-fit: cover;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .price-text {
            color: #F27A7A;
            font-weight: bold;
            font-size: 2rem;
        }
        .original-price {
            color: #6c757d;
            text-decoration: line-through;
            font-size: 1.2rem;
        }
        .rating-stars {
            color: #ffc107;
        }
        .quantity-input {
            width: 80px;
            text-align: center;
        }
        .btn-quantity {
            width: 35px;
            height: 38px;
        }
        .product-badge {
            background: linear-gradient(45deg, #F27A7A, #ff9999);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .btn-cart {
            background: linear-gradient(45deg, #F27A7A, #ff9999);
            border: none;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-cart:hover {
            background: linear-gradient(45deg, #e66b6b, #f58888);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(242, 122, 122, 0.3);
        }
        .btn-buy {
            background: linear-gradient(45deg, #28a745, #34ce57);
            border: none;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-buy:hover {
            background: linear-gradient(45deg, #218838, #28a745);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="/img/zootopialogo.png" alt="Zootopia" style="height:150px;" onerror="this.style.display='none'">
            </a>
            
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/products/listp">ì „ì²´ìƒí’ˆ</a>
                <a class="nav-link" href="/">ìŠ¤í† ì–´</a>
                <a class="nav-link" href="/">ì„œë¹„ìŠ¤</a>
                <a class="nav-link" href="/">ì»¤ë®¤ë‹ˆí‹°</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- ë¸Œë ˆë“œí¬ëŸ¼ -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/" class="text-decoration-none">í™ˆ</a></li>
                <li class="breadcrumb-item"><a href="/products/listp" class="text-decoration-none">ìƒí’ˆ</a></li>
                <li class="breadcrumb-item"><span th:text="${productCategory}">ì¹´í…Œê³ ë¦¬</span></li>
                <li class="breadcrumb-item active" aria-current="page" th:text="${productName}">ìƒí’ˆëª…</li>
            </ol>
        </nav>

        <!-- ìƒí’ˆ ìƒì„¸ ì •ë³´ -->
        <div class="row">
            <!-- ìƒí’ˆ ì´ë¯¸ì§€ -->
            <div class="col-lg-6 mb-4">
                <div class="text-center">
                    <img th:src="${productImage}" 
                         class="img-fluid product-image" 
                         alt="ìƒí’ˆ ì´ë¯¸ì§€"
                         th:alt="${productName}"
                         onerror="this.src='/assets/dist/img/default-thumbnail.png'">
                </div>
                
                <!-- ì‘ì€ ì´ë¯¸ì§€ë“¤ (ì°¨í›„ ì¶”ê°€ ì˜ˆì •) -->
                <div class="row mt-3">
                    <div class="col-3">
                        <img src="/assets/dist/img/products/productcatbellnecklace.png" class="img-fluid rounded" alt="ìƒí’ˆ ì´ë¯¸ì§€ 1">
                    </div>
                    <div class="col-3">
                        <img src="/assets/dist/img/products/productcatwaterbowl.png" class="img-fluid rounded" alt="ìƒí’ˆ ì´ë¯¸ì§€ 2">
                    </div>
                    <div class="col-3">
                        <img src="/assets/dist/img/products/productdogbowl.png" class="img-fluid rounded" alt="ìƒí’ˆ ì´ë¯¸ì§€ 3">
                    </div>
                    <div class="col-3">
                        <img src="/assets/dist/img/products/productpetbed.png" class="img-fluid rounded" alt="ìƒí’ˆ ì´ë¯¸ì§€ 4">
                    </div>
                </div>
            </div>
            
            <!-- ìƒí’ˆ ì •ë³´ -->
            <div class="col-lg-6">
                <!-- ì¹´í…Œê³ ë¦¬ ë°°ì§€ -->
                <div class="mb-2">
                    <span class="product-badge" th:text="${productCategory}">ì¹´í…Œê³ ë¦¬</span>
                </div>
                
                <!-- ìƒí’ˆëª… -->
                <h1 class="mb-3" th:text="${productName}">ìƒí’ˆëª…</h1>
                
                <!-- í‰ì  ë° ë¦¬ë·° -->
                <div class="d-flex align-items-center mb-3">
                    <div class="rating-stars me-2">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star-half-alt"></i>
                    </div>
                    <span class="me-2" th:text="${productRating}">4.5</span>
                    <small class="text-muted">
                        (<span th:text="${productReviewCount}">120</span>ê°œ ë¦¬ë·°)
                    </small>
                </div>
                
                <!-- ê°€ê²© -->
                <div class="mb-4">
                    <p class="text-muted mb-1">ê°€ê²©</p>
                    <div class="d-flex align-items-center">
                        <span class="original-price me-3" th:text="${productPrice + 5000} + 'ì›'">25,000ì›</span>
                        <span class="price-text" th:text="${productPrice} + 'ì›'">20,000ì›</span>
                        <span class="badge bg-danger ms-2">20% í• ì¸</span>
                    </div>
                </div>
                
                <!-- ì¬ê³  ì •ë³´ -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">ì¬ê³ </span>
                        <span th:text="${productStock} + 'ê°œ ë‚¨ìŒ'" class="fw-bold text-success">50ê°œ ë‚¨ìŒ</span>
                    </div>
                </div>
                
                <!-- ìˆ˜ëŸ‰ ì„ íƒ -->
                <div class="mb-4">
                    <label class="form-label fw-bold">ìˆ˜ëŸ‰</label>
                    <div class="d-flex align-items-center">
                        <button type="button" class="btn btn-outline-secondary btn-quantity" id="decreaseBtn">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" class="form-control quantity-input mx-2" 
                               id="quantityInput" value="1" min="1" th:max="${productStock}">
                        <button type="button" class="btn btn-outline-secondary btn-quantity" id="increaseBtn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <small class="text-muted">ìµœëŒ€ ì£¼ë¬¸ ê°€ëŠ¥ ìˆ˜ëŸ‰: <span th:text="${productStock}">50</span>ê°œ</small>
                </div>
                
                <!-- ì´ ê°€ê²© -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                        <span class="fw-bold">ì´ ê°€ê²©</span>
                        <span class="price-text" id="totalPrice" th:text="${productPrice} + 'ì›'">20,000ì›</span>
                    </div>
                </div>
                
                <!-- ë²„íŠ¼ ì˜ì—­ -->
                <div class="mb-4">
                    <form th:action="@{/cart/add-form}" method="post" id="cartForm">
                        <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
                        <input type="hidden" name="productNo" th:value="${productNo}" />
                        <input type="hidden" name="quantity" id="cartQuantityInput" value="1" />
                        <div class="d-grid gap-3">
                            <button type="submit" class="btn btn-cart btn-lg" id="addToCartBtn">
                                <i class="fas fa-shopping-cart me-2"></i>
                                ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
                            </button>
                        </div>
                    </form>
                    <form th:action="@{/checkout}" method="post" id="buyNowForm" class="mt-2">
                        <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
                        <input type="hidden" name="productNo" th:value="${productNo}" />
                        <input type="hidden" name="quantity" id="buyNowQuantityInput" th:value="${quantity != null ? quantity : 1}" />
                        <div class="d-grid gap-3">
                            <button type="submit" class="btn btn-buy btn-lg" id="buyNowBtn">
                                <i class="fas fa-credit-card me-2"></i>
                                ë°”ë¡œ êµ¬ë§¤
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- ìƒí’ˆ ì„¤ëª… -->
                <div class="mb-4">
                    <h5 class="fw-bold">ìƒí’ˆ ì„¤ëª…</h5>
                    <p class="text-muted" th:text="${productDescription}">ìƒí’ˆ ì„¤ëª…</p>
                </div>
                
                <!-- ì¶”ê°€ ì •ë³´ -->
                <div class="row text-center">
                    <div class="col-4">
                        <div class="p-3">
                            <i class="fas fa-truck text-primary fs-4"></i>
                            <div class="mt-2">
                                <small class="fw-bold">ë¬´ë£Œë°°ì†¡</small><br>
                                <small class="text-muted">3ë§Œì› ì´ìƒ</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-3">
                            <i class="fas fa-undo text-success fs-4"></i>
                            <div class="mt-2">
                                <small class="fw-bold">ë¬´ë£Œ ë°˜í’ˆ</small><br>
                                <small class="text-muted">30ì¼ ì´ë‚´</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-3">
                            <i class="fas fa-headset text-warning fs-4"></i>
                            <div class="mt-2">
                                <small class="fw-bold">ê³ ê°ì§€ì›</small><br>
                                <small class="text-muted">24ì‹œê°„</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <a href="/products/listp" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        // ìƒí’ˆ ê°€ê²© ì •ë³´
        const productPrice = /*[[${productPrice}]]*/ 20000;
        const maxStock = /*[[${productStock}]]*/ 50;
        
        // DOMì´ ë¡œë“œëœ í›„ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing quantity controls...');
            
            // DOM ìš”ì†Œë“¤
            const quantityInput = document.getElementById('quantityInput');
            const decreaseBtn = document.getElementById('decreaseBtn');
            const increaseBtn = document.getElementById('increaseBtn');
            const totalPriceElement = document.getElementById('totalPrice');
            const cartQuantityInput = document.getElementById('cartQuantityInput');
            const buyNowQuantityInput = document.getElementById('buyNowQuantityInput');
            
            console.log('Elements found:', {
                quantityInput: !!quantityInput,
                decreaseBtn: !!decreaseBtn,
                increaseBtn: !!increaseBtn,
                totalPriceElement: !!totalPriceElement
            });
            
            if (!quantityInput || !decreaseBtn || !increaseBtn || !totalPriceElement) {
                console.error('Required elements not found!');
                return;
            }
            
            // ìˆ˜ëŸ‰ ì¦ê°€
            increaseBtn.addEventListener('click', function() {
                console.log('Increase button clicked');
                let currentQuantity = parseInt(quantityInput.value) || 1;
                console.log('Current quantity:', currentQuantity, 'Max stock:', maxStock);
                
                if (currentQuantity < maxStock) {
                    quantityInput.value = currentQuantity + 1;
                    console.log('New quantity:', quantityInput.value);
                    updateTotalPrice();
                    syncQuantityHiddenInputs();
                } else {
                    console.log('Maximum stock reached');
                    alert('ìµœëŒ€ ì£¼ë¬¸ ê°€ëŠ¥ ìˆ˜ëŸ‰ì€ ' + maxStock + 'ê°œì…ë‹ˆë‹¤.');
                }
            });
            
            // ìˆ˜ëŸ‰ ê°ì†Œ
            decreaseBtn.addEventListener('click', function() {
                console.log('Decrease button clicked');
                let currentQuantity = parseInt(quantityInput.value) || 1;
                console.log('Current quantity:', currentQuantity);
                
                if (currentQuantity > 1) {
                    quantityInput.value = currentQuantity - 1;
                    console.log('New quantity:', quantityInput.value);
                    updateTotalPrice();
                    syncQuantityHiddenInputs();
                } else {
                    console.log('Minimum quantity reached');
                }
            });
            
            // ìˆ˜ëŸ‰ ì§ì ‘ ì…ë ¥ ì‹œ
            quantityInput.addEventListener('input', function() {
                let quantity = parseInt(this.value);
                if (isNaN(quantity) || quantity < 1) {
                    this.value = 1;
                } else if (quantity > maxStock) {
                    this.value = maxStock;
                    alert('ìµœëŒ€ ì£¼ë¬¸ ê°€ëŠ¥ ìˆ˜ëŸ‰ì€ ' + maxStock + 'ê°œì…ë‹ˆë‹¤.');
                }
                updateTotalPrice();
                syncQuantityHiddenInputs();
            });
            
            // ìˆ˜ëŸ‰ hidden input ë™ê¸°í™”
            function syncQuantityHiddenInputs() {
                if (cartQuantityInput) cartQuantityInput.value = quantityInput.value;
                if (buyNowQuantityInput) buyNowQuantityInput.value = quantityInput.value;
                console.log('Hidden inputs synced to:', quantityInput.value);
            }
            
            // ì´ ê°€ê²© ì—…ë°ì´íŠ¸
            function updateTotalPrice() {
                const quantity = parseInt(quantityInput.value) || 1;
                const totalPrice = productPrice * quantity;
                totalPriceElement.textContent = totalPrice.toLocaleString() + 'ì›';
                console.log('Total price updated:', totalPrice);
            }
            
            // ì´ˆê¸° ì„¤ì •
            updateTotalPrice();
            syncQuantityHiddenInputs();
            console.log('Quantity controls initialized successfully');
            
            // ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const cartForm = document.getElementById('cartForm');
            if (cartForm) {
                console.log('âœ… ì¥ë°”êµ¬ë‹ˆ í¼ ì°¾ìŒ:', cartForm);
                
                cartForm.addEventListener('submit', function(e) {
                    console.log('ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° í¼ ì œì¶œ ì´ë²¤íŠ¸ ë°œìƒ!');
                    
                    // í¼ ì œì¶œ ì§ì „ì— ìˆ˜ëŸ‰ ë™ê¸°í™” í•œ ë²ˆ ë” ìˆ˜í–‰
                    syncQuantityHiddenInputs();
                    
                    const productNoInput = document.querySelector('input[name="productNo"]');
                    const quantityInput = document.querySelector('input[name="quantity"]');
                    const csrfInput = document.querySelector('input[name="_csrf"]');
                    
                    console.log('ğŸ“‹ í¼ ë°ì´í„°:', { 
                        productNo: productNoInput ? productNoInput.value : 'NOT FOUND',
                        quantity: quantityInput ? quantityInput.value : 'NOT FOUND',
                        csrf: csrfInput ? 'CSRF í† í° ìˆìŒ' : 'CSRF í† í° ì—†ìŒ',
                        action: cartForm.action,
                        method: cartForm.method
                    });
                    
                    // ìˆ˜ëŸ‰ì´ ìœ íš¨í•œì§€ í™•ì¸
                    if (!quantityInput || !quantityInput.value || quantityInput.value < 1) {
                        e.preventDefault();
                        alert('ìˆ˜ëŸ‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        console.log('âŒ ìˆ˜ëŸ‰ì´ ìœ íš¨í•˜ì§€ ì•Šì•„ í¼ ì œì¶œ ì·¨ì†Œ');
                        return false;
                    }
                    
                    console.log('âœ… í¼ ì œì¶œ ì§„í–‰ ì¤‘...');
                    // í¼ ì œì¶œì„ ê³„ì† ì§„í–‰
                });
            } else {
                console.error('âŒ ì¥ë°”êµ¬ë‹ˆ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ!');
            }
        });
    </script>

    <!-- Header JS -->
    <script src="/assets/dist/js/header.js"></script>

    <!-- Footer Fragment -->
    <div th:replace="fragments/footer :: footer"></div>
</body>
</html>