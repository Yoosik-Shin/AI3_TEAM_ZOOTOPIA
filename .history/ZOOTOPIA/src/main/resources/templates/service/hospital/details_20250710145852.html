<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë³‘ì› ìƒì„¸</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/hospital_style.css}">
</head>
<body>
    <th:block th:replace="~{/fragments/header :: header}"></th:block>
    <div class="hospital-main-container">
        <!-- ìƒë‹¨ ë¡œê³  -->
        <div class="logo-container">
            <div class="logo">
                <img th:src="@{/img/hosp_logo.png}" alt="ë³‘ì› ì•„ì´ì½˜" class="logo-icon">
            </div>
        </div>

        <!-- ë™ë¬¼ ë°°ë„ˆ -->
        <div class="animal-banner">
            <div class="animal-icons">
                <span class="animal-icon">ğŸ±</span>
                <span class="animal-icon">ğŸ¶</span>
                <span class="animal-icon">ğŸ¸</span>
                <span class="text">ë³‘ì› ì†Œê°œ</span>
                <span class="animal-icon">ğŸ¦œ</span>
                <span class="animal-icon">ğŸ¹</span>
            </div>
        </div>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="main-content">
            <div class="detail-container">
                <div class="hospital-image-section">
                    <img th:with="imageUrl=${(hospital.thumbnailImageUrl != null and hospital.thumbnailImageUrl != '') ? hospital.thumbnailImageUrl : '/img/default-hospital.png'}"
                         th:src="@{${imageUrl}}" alt="ë³‘ì› ì´ë¯¸ì§€" class="hospital-image">
                    <!-- <img src="hospital-building.jpg" alt="ë³‘ì› ê±´ë¬¼" class="hospital-image"> -->
                </div>

                <div class="hospital-info-section">
                    <table class="info-table">
                        <tr>
                            <td class="info-label">ë³‘ì› ì´ë¦„</td>
                            <td class="info-value" th:text="${hospital.name}">ì•„í¬ë¦¬ìŠ¤ íŠ¹ìˆ˜ë™ë¬¼ ë³‘ì›</td>
                        </tr>
                        <tr>
                            <td class="info-label">ì§„ë£Œ ê³¼ëª©</td>
                            <td class="info-value">
                                <span th:each="spec : ${hospital.specialties}" th:text="${spec.category} + ' '">ì¹˜ê³¼, ì™¸ê³¼, ë‚´ê³¼, ê±´ê°•ê²€ì§„</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="info-label">ì§„ë£Œ ê°€ëŠ¥ ë™ë¬¼</td>
                            <td class="info-value">
                                <span th:each="animal : ${hospital.animals}" th:text="${animal.species} + ' '">í¬ìœ ë¥˜, íŒŒì¶©ë¥˜, ì¡°ë¥˜, ì„¤ì¹˜ë¥˜</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="info-label">ë³‘ì› ì£¼ì†Œ</td>
                            <td class="info-value" th:text="${hospital.address}">ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì˜ì€ì‚¬ë¡œ 104ê¸¸ 10 ë™í™”ë¹Œë”© 3ì¸µ</td>
                        </tr>
                        <tr>
                            <td class="info-label">í™ˆí˜ì´ì§€</td>
                            <td class="info-value">
                                <a th:href="${hospital.homepage}" th:text="${hospital.homepage}">https://acrisamc.co.kr/</a>
                            </td>
                        </tr>
                        <tr>
                            <td class="info-label">ëŒ€í‘œë²ˆí˜¸</td>
                            <td class="info-value" th:text="${hospital.phone}">02-583-7582</td>
                        </tr>
                        <tr>
                            <td class="info-label">ì´ë©”ì¼</td>
                            <td class="info-value" th:text="${hospital.email}">X</td>
                        </tr>
                        <tr>
                            <td class="info-label">ë³‘ì› ì†Œê°œ</td>
                            <td class="info-value" th:text="${hospital.hospIntroduce}">X</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- ê´€ë¦¬ììš© ë²„íŠ¼ -->
            <div class="mb-3" style="text-align: right; margin-top: 20px;" sec:authorize="hasAuthority('ROLE_ADMIN')">
                <a th:href="@{/hospitals/edit/{id}(id=${hospital.hospitalId})}" class="btn btn-primary">ìˆ˜ì •í•˜ê¸°</a>
            </div>

            <!-- ë¦¬ë·° ì„¹ì…˜ -->
            <div class="review-section">
                <div class="review-header">
                    <h3>ì´ ë³‘ì› ì–´ë•Œìš”?</h3>
                </div>

                <div class="review-stats">
                    <span class="review-count" th:text="'ëŒ“ê¸€ ê°œìˆ˜ ' + ${#lists.size(hospital.reviews)}">ëŒ“ê¸€ ê°œìˆ˜ 100</span>
                </div>

                <p>DEBUG: hospital.reviews ë¦¬ìŠ¤íŠ¸ í¬ê¸°: <span th:text="${#lists.size(hospital.reviews)}"></span></p>

                <div class="review-list">
                    <div th:if="${#lists.isEmpty(hospital.reviews)}" class="no-reviews-message" style="text-align: center; padding: 20px; color: #666;">
                        <p>ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                    <!-- Thymeleaf ë°˜ë³µë¬¸ ëŒ€ì‹  JavaScriptë¡œ ë¦¬ë·° ë Œë”ë§ -->
                    <div id="review-items-container">
                        <!-- ë¦¬ë·° ì•„ì´í…œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <!-- ë¦¬ë·° ì‘ì„± í¼ -->
                <div class="review-form" sec:authorize="isAuthenticated()">
                    <form th:action="@{/hospitals/{id}/reviews(id=${hospital.hospitalId})}" method="post" th:object="${reviewForm}">
                        <div class="review-container">
                            <div class="star-rating">
                                <input type="radio" th:field="*{rating}" id="star5" value="5"><label for="star5">â­â­â­â­â­</label>
                                <input type="radio" th:field="*{rating}" id="star4" value="4"><label for="star4">â­â­â­â­</label>
                                <input type="radio" th:field="*{rating}" id="star3" value="3"><label for="star3">â­â­â­</label>
                                <input type="radio" th:field="*{rating}" id="star2" value="2"><label for="star2">â­â­</label>
                                <input type="radio" th:field="*{rating}" id="star1" value="1"><label for="star1">â­</label>
                            </div>
                            <div class="review-input-container">
                                <input type="text" th:field="*{content}" placeholder="ì´ ë³‘ì› ì–´ë•Œìš”? ë‹¤ë¥¸ ë¶„ë“¤ì—ê²Œ ë„ì›€ì´ ë˜ëŠ” ì˜ˆìœë§ì„ ë‚¨ê²¨ì£¼ì„¸ìš”" class="review-input" required>
                                <button type="submit" class="review-submit-btn">ë‚¨ê¸°ê¸°</button>
                            </div>
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <th:block th:replace="~{/fragments/footer :: footer}"></th:block>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ë¦¬ë·° ë°ì´í„°ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const hospitalReviews = [[${hospital.reviews}]] || [];
        const hospitalId = [[${hospital.hospitalId}]];
        const isAuthenticated = [[${#authentication != null and #authentication.isAuthenticated()}]];
        const currentUserId = isAuthenticated ? [[${#authentication.principal.user.userId}]] : null;
        const csrfParameterName = '[[${_csrf.parameterName}]]';
        const csrfToken = '[[${_csrf.token}]]';

        // ğŸ ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ (ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ í™•ì¸)
        console.log("Thymeleaf ì¸ë¼ì¸ í‘œí˜„ì‹ ì›ë³¸: ", "[[${hospital.reviews}]]");
        console.log("JavaScript hospitalReviews ë³€ìˆ˜: ", hospitalReviews);
        console.log("JavaScript hospitalReviews.length: ", hospitalReviews.length);

        const reviewItemsContainer = document.getElementById('review-items-container');

        if (hospitalReviews.length === 0) {
            const noReviewsMessage = document.createElement('div');
            noReviewsMessage.className = 'no-reviews-message';
            noReviewsMessage.style.textAlign = 'center';
            noReviewsMessage.style.padding = '20px';
            noReviewsMessage.style.color = '#666';
            noReviewsMessage.innerHTML = '<p>ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            reviewItemsContainer.appendChild(noReviewsMessage);
        } else {
            hospitalReviews.forEach((review, index) => {
                const reviewItem = document.createElement('div');
                reviewItem.className = 'review-item';
                reviewItem.id = `review-item-${review.reviewId}`;

                let starsHtml = '';
                if (review.rating != null) {
                    for (let i = 0; i < review.rating; i++) {
                        starsHtml += 'â­';
                    }
                }

                const formattedDate = new Date(review.createdAt).toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }).replace(/\./g, '.').replace(/ /g, ' ').trim();

                reviewItem.innerHTML = `
                    <p>DEBUG: Review ID: ${review.reviewId}, Hospital ID: ${hospitalId}, Review Index: ${index}, Review Count: ${hospitalReviews.length}</p>
                    <div class="author-rating">
                        <div class="review-author">${review.nickname}</div>
                        <div class="review-rating">
                            <span>${starsHtml}</span>
                        </div>
                    </div>
                    <div class="review-date-container">
                        <div class="review-date">${formattedDate}</div>
                    </div>
                    <hr style="margin-bottom: 3px; border: none; border-top: 1px solid #ccc;">
                    <div class="review-content" id="review-content-${review.reviewId}">${review.content}</div>
                    <form action="/hospitals/${hospitalId}/reviews/${review.reviewId}/edit" method="post" class="inline-edit-form" id="edit-form-${review.reviewId}" style="display:none;">
                        <textarea name="content" required style="width:90%;height:60px;">${review.content}</textarea>
                        <button type="submit" class="review-update-btn">ìˆ˜ì •ì™„ë£Œ</button>
                    </form>
                `;

                // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (ë¡œê·¸ì¸ ìƒíƒœ ë° ì‚¬ìš©ì ID í™•ì¸) 
                if (isAuthenticated && currentUserId == review.userId) {
                    const reviewActionsDiv = document.createElement('div');
                    reviewActionsDiv.className = 'review-actions';
                    reviewActionsDiv.innerHTML = `
                        <button type="button" class="hosp-review-update" data-review-id="${review.reviewId}">ìˆ˜ì •</button>
                        <form action="/hospitals/${hospitalId}/reviews/${review.reviewId}/delete" method="post" style="display: inline;">
                            <input type="hidden" name="${csrfParameterName}" value="${csrfToken}" />
                            <button type="submit" class="hosp-review-delete" onclick="return confirm('ì •ë§ë¡œ ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</button>
                        </form>
                    `;
                    reviewItem.appendChild(reviewActionsDiv);
                }

                reviewItemsContainer.appendChild(reviewItem);
            });
        }

        // ê¸°ì¡´ ë¦¬ë·° ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸ (ë™ì ìœ¼ë¡œ ìƒì„±ëœ ìš”ì†Œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°)
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('hosp-review-update')) {
                const reviewId = event.target.getAttribute('data-review-id');
                
                // ëª¨ë“  ìˆ˜ì • í¼ê³¼ ë¦¬ë·° ë‚´ìš©ì„ ì›ë˜ ìƒíƒœë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
                document.querySelectorAll('.review-item').forEach(item => {
                    item.querySelector('.review-content').style.display = 'block';
                    const editForm = item.querySelector('.inline-edit-form');
                    if (editForm) editForm.style.display = 'none';
                });

                // í´ë¦­ëœ ë²„íŠ¼ì— í•´ë‹¹í•˜ëŠ” ìˆ˜ì • í¼ë§Œ ë³´ì—¬ì¤ë‹ˆë‹¤.
                const contentDiv = document.getElementById(`review-content-${reviewId}`);
                const editForm = document.getElementById(`edit-form-${reviewId}`);
                if (contentDiv && editForm) {
                    contentDiv.style.display = 'none';
                    editForm.style.display = 'block';
                }
            }
        });

        // ë¦¬ë·° ì‘ì„± í¼ ìœ íš¨ì„± ê²€ì‚¬
        const reviewForm = document.querySelector('.review-form form');
        if (reviewForm) {
            reviewForm.addEventListener('submit', function(event) {
                const ratingInputs = reviewForm.querySelectorAll('input[name="rating"]');
                let ratingSelected = false;
                for (let i = 0; i < ratingInputs.length; i++) {
                    if (ratingInputs[i].checked) {
                        ratingSelected = true;
                        break;
                    }
                }

                const contentInput = reviewForm.querySelector('input[name="content"]');
                const content = contentInput ? contentInput.value.trim() : '';

                if (!ratingSelected) {
                    alert('ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    event.preventDefault(); // ì œì¶œ ë°©ì§€
                    return;
                }

                if (content === '') {
                    alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    event.preventDefault(); // ì œì¶œ ë°©ì§€
                    return;
                }
            });
        }
    });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
</body>
</html>
        </div>
    </div>
    <th:block th:replace="~{/fragments/footer :: footer}"></th:block>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // ê¸°ì¡´ ë¦¬ë·° ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸
        document.querySelectorAll('.hosp-review-update').forEach(btn => {
            btn.addEventListener('click', (event) => {
                const reviewId = event.target.getAttribute('data-review-id');
                
                // ëª¨ë“  ìˆ˜ì • í¼ê³¼ ë¦¬ë·° ë‚´ìš©ì„ ì›ë˜ ìƒíƒœë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
                document.querySelectorAll('.review-item').forEach(item => {
                    item.querySelector('.review-content').style.display = 'block';
                    item.querySelector('.inline-edit-form').style.display = 'none';
                });

                // í´ë¦­ëœ ë²„íŠ¼ì— í•´ë‹¹í•˜ëŠ” ìˆ˜ì • í¼ë§Œ ë³´ì—¬ì¤ë‹ˆë‹¤.
                const contentDiv = document.getElementById(`review-content-${reviewId}`);
                const editForm = document.getElementById(`edit-form-${reviewId}`);
                contentDiv.style.display = 'none';
                editForm.style.display = 'block';
            });
        });

        // ë¦¬ë·° ì‘ì„± í¼ ìœ íš¨ì„± ê²€ì‚¬
        const reviewForm = document.querySelector('.review-form form');
        if (reviewForm) {
            reviewForm.addEventListener('submit', function(event) {
                const ratingInputs = reviewForm.querySelectorAll('input[name="rating"]');
                let ratingSelected = false;
                for (let i = 0; i < ratingInputs.length; i++) {
                    if (ratingInputs[i].checked) {
                        ratingSelected = true;
                        break;
                    }
                }

                const contentInput = reviewForm.querySelector('input[name="content"]');
                const content = contentInput ? contentInput.value.trim() : '';

                if (!ratingSelected) {
                    alert('ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    event.preventDefault(); // ì œì¶œ ë°©ì§€
                    return;
                }

                if (content === '') {
                    alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    event.preventDefault(); // ì œì¶œ ë°©ì§€
                    return;
                }
            });
        }
    });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
</body>
</html>